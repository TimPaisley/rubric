<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>RuBRIC</title>
    <meta name="description" content="RuBRIC" />
    <meta name="author" content="Wellington City Council" />

    <link rel="stylesheet" href="css/styles.css?v=1.0" />

    <script src="https://wcc-rubric.azurewebsites.net/rubric.min.js"></script>
    <script src="app.js"></script>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.11/esri/css/main.css"
    />
    <script src="https://js.arcgis.com/4.11/"></script>
  </head>

  <body>
    <div id="elm"></div>
    <script>
      var app = Elm.Main.init({
        node: document.getElementById("elm"),
        flags: Object.values(rubric.Types.activity)
      });

      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/widgets/Search",
        "esri/tasks/support/Query"
      ], function(Map, MapView, FeatureLayer, Search, Query) {
        const layer = new FeatureLayer({
          url:
            "https://gis.wcc.govt.nz/arcgis/rest/services/PropertyAndBoundaries/Property/MapServer"
        });

        const activityAreas = new FeatureLayer({
          url:
            "http://gis.wcc.govt.nz/arcgis/rest/services/DistrictPlan/DistrictPlan/MapServer/59"
        });

        const specialResidentialAreas = new FeatureLayer({
          url:
            "http://gis.wcc.govt.nz/arcgis/rest/services/DistrictPlan/DistrictPlan/MapServer/36"
        });

        // 49, 65

        var map = new Map({
          basemap: "dark-gray-vector",
          layers: [layer]
        });

        view = new MapView({
          container: "map",
          map: map,
          center: [174.78060739454546, -41.29645326918087],
          zoom: 10
        });

        var searchWidget = new Search({
          view: view,
          allPlaceholder: "Enter an Address",
          includeDefaultSources: false,
          sources: [
            {
              layer: layer,
              searchFields: ["FullAddress"],
              displayField: "FullAddress",
              exactMatch: false,
              outFields: [
                "FullAddress",
                "StreetNumber",
                "StreetName",
                "Suburb",
                "PostCode",
                "Title",
                "ValuationID",
                "ValuationWUFI"
              ],
              name: "District Plan Zones",
              placeholder: "Enter an Address"
            }
          ]
        });

        view.ui.add(searchWidget, {
          position: "top-right"
        });

        // default for development
        app.ports.selectMapProperty.send({
          dpZone: "Inner Residential",
          fullAddress: "101 Wakefield Street, Wellington Central",
          postCode: "6011",
          specialResidentialArea: "IR 3 - Aro Valley",
          streetName: "Wakefield Street",
          streetNumber: "101",
          suburb: "Wellington Central",
          title: "724107",
          valuationId: "17270-11800",
          valuationWufi: 1921748
        });

        searchWidget.on("select-result", function(event) {
          var attributes = event.result.feature.attributes;

          var query = activityAreas.createQuery();
          query.geometry = event.result.feature.geometry;
          query.spatialRelationship = "intersects";
          query.returnGeometry = true;
          query.outFields = ["dp_zone"];

          activityAreas.queryFeatures(query).then(function(intersection) {
            var dp_zone = intersection.features[0].attributes.dp_zone;

            query.outFields = ["Area_Name"];
            specialResidentialAreas
              .queryFeatures(query)
              .then(function(intersection) {
                var sra_name;
                if (intersection.features[0]) {
                  sra_name = intersection.features[0].attributes.Area_Name;
                } else {
                  sra_name = "Unknown";
                }

                var property = {
                  fullAddress: attributes.FullAddress,
                  streetNumber: attributes.StreetNumber,
                  streetName: attributes.StreetName,
                  suburb: attributes.Suburb,
                  postCode: attributes.PostCode,
                  title: attributes.Title,
                  valuationId: attributes.ValuationID,
                  valuationWufi: attributes.ValuationWUFI,
                  dpZone: dp_zone,
                  specialResidentialArea: sra_name
                };

                app.ports.selectMapProperty.send(property);
              });
          });
        });
      });

      var engine = null;
      app.ports.askRubric.subscribe(function(data) {
        console.log(data);

        if (engine) {
          engine.process(data.answers).then(() => {
            console.log(engine.standards);
            app.ports.receiveStandards.send(engine.standards);
          });
        } else {
          engine = new rubric.Engine({ fields: data.scenario });
          app.ports.receiveStandards.send(engine.standards);
        }
      });
    </script>
  </body>
</html>
