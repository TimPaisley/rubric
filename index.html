<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>RuBRIC</title>
    <meta name="description" content="RuBRIC" />
    <meta name="author" content="Wellington City Council" />

    <link rel="stylesheet" href="css/styles.css?v=1.0" />

    <script src="app.js"></script>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.11/esri/css/main.css"
    />
    <script src="https://js.arcgis.com/4.11/"></script>
  </head>

  <body>
    <div id="elm"></div>
    <script>
      var app = Elm.Main.init({
        node: document.getElementById("elm")
      });

      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/widgets/Search"
      ], function(Map, MapView, FeatureLayer, Search) {
        const layer = new FeatureLayer({
          url:
            "https://gis.wcc.govt.nz/arcgis/rest/services/PropertyAndBoundaries/Property/MapServer"
        });

        var map = new Map({
          basemap: "dark-gray-vector",
          layers: [layer]
        });

        view = new MapView({
          container: "map",
          map: map,
          center: [174.78060739454546, -41.29645326918087],
          zoom: 10
        });

        var searchWidget = new Search({
          view: view,
          allPlaceholder: "Enter an Address",
          includeDefaultSources: false,
          sources: [
            {
              layer: layer,
              searchFields: ["FullAddress"],
              displayField: "FullAddress",
              exactMatch: false,
              outFields: ["FullAddress", "Suburb", "ValuationWUFI"],
              name: "District Plan Zones",
              placeholder: "Enter an Address"
            }
          ]
        });

        view.ui.add(searchWidget, {
          position: "top-right"
        });

        searchWidget.on("select-result", function(event) {
          var attributes = event.result.feature.attributes;
          var property = {
            address: attributes.FullAddress,
            wufi: attributes.ValuationWUFI
          };

          app.ports.selectMapProperty.send(property);
        });
      });
    </script>
  </body>
</html>
